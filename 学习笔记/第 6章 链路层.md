# 第 6 章 链路层
# 概论
## 数据链路层和局域网
- WAN:网络形式采用点到点链路
  - 带宽大、距离远（延迟大） >带宽延迟积大
  - 如果采用多点连接方式
    - 竞争方式：一旦冲突代价大
    - 令牌等协调方式：在其中协调节点的发送代价大
- 点到点链路的链路层服务实现非常简单，封装和解封装
- LAN 一般采用多点连接方式
  - 连接节点非常方便
  - 接到共享型介质上（或网络交换机），就可以连接所有其他节点
- 多点连接方式网络的链路层功能实现相当复杂
  - 多点接入：协调各节点对共享性介质的访问和使用
  - 竞争方式：冲突之后的协调
  - 令牌方式：令牌产生，占有和释放等
## 概念
**术语**
- 主机和路由器是节点（网桥和
  交换机也是）：nodes
- 沿着通信路径,连接个相邻节
  点通信信道的是链路：links
  - 有线链路
  - 无线链路
  - 局域网，共享性链路
- 第二层协议数据单元帧 frame，封装数据报
- 数据链路层负责从一个节点通过链路将
  （帧中的）数据报发送到相邻的物理节点
  （一个子网内部的 2 节点）
  **上下文**
- 数据报（分组）在不同的链路上以不同的链路协议传送：
  - 第一跳链路：以太网
  - 中间链路：帧中继链路
  - 最后一跳 802.11
- 不同的链路协议提供不同的服务
  - e.g.,比如在链路层上提供（或没有）可靠数据传送**服务**
- 成帧，链路接入
  - 将数据报封装在帧中，加上帧头、帧尾部
  - 如果采用的是共享性介质，信道接入获得信道访问权
  - 在帧头部使用“MAC”（物理）地址来标示源和目的
- 在（一个网络内）相邻两个节点完成可靠数据传递
  - 在低出错率的链路上（光纤和双绞线电缆）很少使用
  - 在无线链路经常使用：出错率高
- 在相邻节点间（一个子网内）进行可靠的转发
- 流量控制 → 使得相邻的发送和接收方节点的速度匹配
- 错误检测
  - 差错由信号衰减和噪声引起
  - 接收方检测出的错误
- 差错纠正
  - 接收端检查和纠正 bit 错误，不通过重传来纠正错误
- 半双工和全双工:
  - 半双工：链路可以双向传输，但一次只有一个方向
    **实现**
- 在每一个主机上
  - 也在每个路由器上
  - 交换机的每个端口上
- 链路层功能在“适配器”上实现 (aka network interface card NIC) 或者在一个芯片组上
  - 以太网卡，802.11 网卡; 以太网芯片组
  - 实现链路层和相应的物理层功能
- 接到主机的系统总线上
- 硬件、软件和固件的综合体
  **通信**
  ![](https://raw.githubusercontent.com/xuekanhua/images/master/img/image_eDqtWHyfKW.png)
  发送方:
- 在帧中封装数据报
- 加上差错控制编码，实现 RDT 和流量控制功能等
  接收方
- 检查有无出错，执行 rdt 和流量控制功能等
- 解封装数据报，将至交给上层
# 差错检测与纠正
## 错误检测
- EDC=差错检测和纠正位（冗余位）
- D =数据由差错检测保护，可以包含头部字段
- 错误检测不是 100%可靠的!
  - 协议会漏检一些错误，但是很少
  - 更长的 EDC 字段可以得到更好的检测和纠正效果
## 奇偶校验
- 单 bit 奇偶校验:检测单个 bit 级错误
- 2 维奇偶校验：检测和纠正单个 bit 错误
## 校验和
- 目标: 检测在传输报文段时的错误（如位翻转），（注：仅仅用在传输层）
- 发送方:
  - 将报文段看成 16-bit 整数
  - 报文段的校验和: 和 (1’的补码和)
  - 发送方将 checksum 的值放在‘UDP 校验和’字段
- 接收方:
  - 计算接收到的报文段的校验和
  - 检查是否与携带校验和字段值一致:
    - 不一致：检出错误
    - 一致：没有检出错误，但可能还是有错误
## 检验和：CRC（循环冗余校验）
- 强大的差错检测码
- 将数据比特 D, 看成是二进制的数据
- 生成多项式 G：双方协商 r+1 位模式（r 次方）
  - 生成和检查所使用的位模式
- 目标:选择 r 位 CRC 附加位 R，使得
  - \<D,R> 正好被 G 整除 (modulo 2)
  - 接收方知道 G, 将 \<D,R>除以 G. 如果非 0 余数: 检查出错误!
  - 能检出所有少于 r+1 位的突发错误
- 实际中广泛使用（以太网、802.11 WiFi、ATM）
  ![](https://raw.githubusercontent.com/xuekanhua/images/master/img/image_oaFyQLkefM.png)
### CRC 性能分析
- 突发错误和突发长度
- CRC 检错性能描述
  - 能够检查出所有的 1bit 错误
  - 能够检查出所有的双 bits 的错误
  - 能够检查出所有长度 =r 或者\<r 位的错误
  - 出现长度为 r+1 的突发错误，检查不出的概率是
    $\frac{1}{2^{r - 1}}$
  - 出现长度大于 r+1 的突发错误，检查不出的概率
    $\frac{1}{2^{r}}$
# 多点访问协议
- 点对点
  - 拨号访问的 PPP
  - 以太网交换机和主机之间的点对点链路
- 广播 (共享线路或媒体)
  - 传统以太网
  - HFC 上行链路
  - 802.11 无线局域
## 多路访问
- 单个共享的广播型链路
- 2 个或更多站点同时传送: 冲突（collision）
  - 多个节点在同一个时刻发送，则会收到 2 个或多个信号叠加
- 多路访问协议（介质访问控制协议：MAC）
  - 分布式算法-决定节点如何使用共享信道，即：决
    定节点什么时候可以发送
  - 关于共享控制的通信必须用借助信道本身传输！
  - 没有带外的信道，各节点使用其协调信道使用
  - 用于传输控制信息
## MAC（媒体访问控制）协议：分类
1.  信道划分
    - 把信道划分成小片（时间、频率、编码）
    - 分配片给每个节点专用
2.  随机访问
    - 信道不划分，允许冲突
    - 冲突后恢复
3.  依次轮流
    - 节点依次轮流
    - 但是有很多数据传输的节点可以获得较长的信道使用权
### 信道划分
- TDMA
  - DMA:time division multiple access
  - 轮流使用信道，信道的时间分为周期
  - 每个站点使用每周期中固定的时隙(长度=帧传输时间)传输帧
  - 如果站点无帧传输，时隙空闲 → 浪费
  - 如：6 站 LAN，1、3、4 有数据报，时隙 2、5、6 空闲
- FDMA
  - FDMA: frequency division multiple access
  - 信道的有效频率范围被分成一个个小的频段
  - 每个站点被分配一个固定的频段
  - 分配给站点的频段如果没有被使用，则空闲
  - 例如：6 站 LAN，1、3、4 有数据报，频段 2、5、 6 空闲
- CDMA
  - CDMA (code division multiple access) :
    - 所有站点在整个频段上同时进行传输, 采用编码原理加以区分
    - 完全无冲突
    - 假定:信号同步很好,线性叠加
  - 比方
    - TDM:不同的人在不同的时刻讲话
    - FDM:不同的组在不同的小房间里通信
    - CDMA:不同的人使用不同的语言讲话
### 随机存取协议
- 当节点有帧要发送时
  - 以信道带宽的全部 R bps 发送
  - 没有节点间的预先协调
- 两个或更多节点同时传输，会发生 ➜ 冲突“collision”
- 随机存取协议规定:
  - 如何检测冲突
  - 如何从冲突中恢复（如：通过稍后的重传）
- 随机 MAC 协议:
  - 时隙 ALOHA
  - ALOHA
  - CSMA, CSMA/CD, CSMA/CA
1.  时隙 ALOHA
2.  纯 ALOHA
3.  CSMA(载波侦听多路访问)
4.  CSMA/CD(冲突检测)
    - 载波侦听 CSMA：和在 CSMA 中一样发送前侦听信道
    - 没有传完一个帧就可以在短时间内检测到冲突
    - 冲突发生时则传输终止，减少对信道的浪费
      冲突检测 CD 技术，有线局域网中容易实现：
    - 检测信号强度，比较传输与接收到的信号是否相同
    - 通过周期的过零点检测
      **以太网 CSMA/CD 算法**
    1.  适配器获取数据报，创建帧
    2.  发送前：侦听信道 CS
        1.   闲：开始传送帧
        2.   忙：一直等到闲再发送
    3.  发送过程中，冲突检测 CD
        1.  没有冲突:成功
        2.  检测到冲突:放弃,之后尝试重发
    4.  发送方适配器检测到冲突，除放弃外，还发送一个 Jam 信号，所有听到冲突的适配器也是如此
        1.  强化冲突：让所有站点都知道冲突
    5.  如果放弃，适配器进入指数退避状态
        1.  在第 m 次失败后，适配器随机选择一个{0，1，2， ， $2^{m-1}$}中 K，等待 K\*512 位时，然后转到步骤 2
        2.  exponential backoff 二进制指数退避算法
          **CSMA/CD 效率**
    - Tprop = LAN 上 2 个节点的最大传播延迟
    - ttrans = 传输最大帧的时间
    - $efficiency = \frac {1} {1 + 5 t_{prop} / t_{trans} }$
    - 效率变为 1
      - 当 tprop 变成 0 时
      - 当 ttrans 变成无穷大时
        **无线局域网中的 MAC：CSMA/CA**
    - 无法检测冲突：自身信号远远大于其他节点信号
    - 即使能 CD：冲突!=成功
    - 目标: avoid collisions: CSMA/C(ollision)A(voidance)
      - 无法 CD，一旦发送一股脑全部发送完毕，不 CD
      - 为了避免无 CD 带来的信道利用率低的问题，事前进行冲突避免
        **发送方**
    - 如果站点侦测到信道空闲持续 DIFS 长，则传输整个帧 (no CD)
    - 如果侦测到信道忙碌，那么 选择一个随机回退值，并在信道空闲时递减该值；如果信道忙碌，回退值不会变化到数到 0 时（只生在信道闲时）发送整个帧如果没有收到 ACK, 增加回退值，重复
      **接收方**
    - 如果帧正确，则在 SIFS 后发送 ACK
      **冲突避免**
      思想: 允许发送方“预约”信道，而不是随机访问该信道: 避免长数据帧的冲突（可选项）
    - 发送方首先使用 CSMA 向 BS 发送一个小的 RTS 分组
      - RTS 可能会冲突（但是由于比较短，浪费信道较少）
    - BS 广播 clear-to-send CTS，作为 RTS 的响应
    - CTS 能够被所有涉及到的节点听到
      - 发送方发送数据帧
      - 其它节点抑制发送
### 轮流(Taking Turns)MAC 协议
1.  轮询
    - 主节点邀请从节点依次传送
    - 从节点一般比较“dumb”
      缺点
    - 轮询开销：轮询本身消耗信道带宽
    - 等待时间：每个节点需等到主节点轮询后开始传输，即使只有一个节点，也需要等到轮询一周后才能够发送
    - 单点故障：主节点失效时造成整个系统无法工作
2.  令牌递转
    - 控制令牌( token)循环从一
      个节点到下一个节点传递
    - 令牌报文：特殊的帧
      缺点
    - 令牌开销：本身消耗带宽
    - 延迟：只有等到抓住令牌，才可传输
    - 单点故障 (token)：
      - 令牌丢失系统级故障，整个系统无法传输
      - 复杂机制重新生成令牌
# LANs
## MAC 地址和 ARP
- 32bit IP 地址:
  - 网络层地址
  - 前 n-1 跳：用于使数据报到达目的 IP 子网
  - 最后一跳：到达子网中的目标节点
- LAN（MAC/物理/以太网）地址:
  - 用于使帧从一个网卡传递到与其物理连接的另一个网卡(在同一个物理网络中)
  - 48bit MAC 地址固化在适配器的 ROM，有时也可以通过软件设定
  - 理论上全球任何 2 个网卡的 MAC 地址都不相同
    **IP 地址和 MAC 地址的作用不同**
- IP 地址是分层的
- mac 地址是一个平面的
- 分离的优点
  - 网卡坏了，ip 不变，可以捆绑到另外一个网卡的 mac 上
  - 物理网络还可以除 IP 之外支持其他网络层协议，链路协议为任意 上层网络协议， 如 IPX 等
- 捆绑的缺点
  - 如果仅仅使用 IP 地址，不用 mac 地址，那么它仅支持 IP 协议
  - 每次上电都要重新写入网卡 IP 地址；
  - 另外一个选择就是不使用任何地址；不用 MAC 地址，则每到来一个帧都要上传到 IP 层次，由它判断是不是需要接受，干扰一次
    **局域网上每个适配器都有一个唯一的 LAN 地址**
    ![](https://raw.githubusercontent.com/xuekanhua/images/master/img/image_dgViGThQI4.png)
- MAC 地址由 IEEE 管理和分配
- 制造商购入 MAC 地址空间（保证唯一性）
- MAC 平面地址 ➜ 支持移动
- IP 地址有层次-不能移动
  - 依赖于节点连接的 IP 子网，与子网的网络号相同（有与其相连的子网相同的网络前缀）
## ARP: Address Resolution Protocol
- 在 LAN 上的每个 IP 节点都有一个 ARP 表
- ARP 表：包括一些 LAN 节点 IP/MAC 地址的映射
  **在同一个 LAN (网络)**
- A 要发送帧给 B(B 的 IP 地址已知)， 但 B 的 MAC 地址不在 A 的 ARP 表中
- A 广播包含 B 的 IP 地址的 ARP 查询包
  - Dest MAC address = FF-FF-FF-FF-FF-FF
  - LAN 上的所有节点都会收到该查询包
- B 接收到 ARP 包，回复 A 自己的 MAC 地址
  - 帧发送给 A
  - 用 A 的 MAC 地址（单播）
- A 在自己的 ARP 表中，缓存 IP-to-MAC 地址映射关系
  - 软状态: 靠定期刷新维持的系统状态
  - 定期刷新周期之间维护的状态信息可能和原有系统不一致
- ARP 是即插即用的
  - 节点自己创建 ARP 的表项
  - 无需网络管理员的干预
    **路由到其他 LAN**
    ![](https://raw.githubusercontent.com/xuekanhua/images/master/img/image_HDnF_Cn0q3.png)
    发送数据报：由 A 通过 R 到 B，假设 A 知道 B 的 IP 地址
- 在 R 上有两个 ARP 表，分别对应两个 LAN
- 在源主机的路由表中，发现到目标主机的下一跳时 111.111.111.110
- 在源主机的 ARP 表中，发现其 MAC 地址是 E6-E9-00-17-BB-4B, etc
## 以太网
### 物理拓扑
- 总线：在上个世纪 90 年代中期很流行
  - 所有节点在一个碰撞域内，一次只允许一个节点发送
  - 可靠性差，如果介质破损，截面形成信号的反射，发送节点误认为是冲突，总是冲突
- 星型：目前最主流
  - 连接选择: hub 或者 switch
  - 现在一般是交换机在中心
  - 每个节点以及相连的交换机端口使用（独立的）以太网协议（不会和其他节点的发送产生碰撞）
### 以太帧结构
![](https://raw.githubusercontent.com/xuekanhua/images/master/img/image_m-TcQsADwn.png)
- 前导码
  - 用来同步接收方和发送方的时钟速率
    - 使得接收方将自己的时钟调到发送端的时钟
    - 从而可以按照发送端的时钟来接收所发送的帧
- 地址：6 字节源 MAC 地址，目标 MAC 地址
  - 如：帧目标地址=本站 MAC 地址，或是广播地址，接收，递交帧中的数据到网络层
  - 否则，适配器忽略该帧
- 类型：指出高层协(大多情况下是 IP，但也支持其它网络层协议 Novell IPX 和 AppleTalk)
- CRC：在接收方校验
  - 如果没有通过校验，丢弃错误帧
    **服务**
- 无连接：帧传输前，发送方和接收方之间没有握手
- 不可靠：接收方适配器不发送 ACKs 或 NAKs 给发送方
  - 递交给网络层的数据报流可能有 gap
  - 如上层使用像传输层 TCP 协议这样的 rdt，gap 会被补上(源主机，TCP 实体)
  - 否则，应用层就会看到 gap
- 以太网的 MAC 协议：采用二进制退避的 CSMA/CD 介质访问控制形式
## Manchester 编码
![](https://raw.githubusercontent.com/xuekanhua/images/master/img/image_Q6pmv5v2qG.png)
- 在 10BaseT 中使用
- 每一个 bit 的位时中间有一个信号跳变
- 允许在接收方和发送方节点之间进行时钟同步  节点间不需要集中的和全局的时钟
- 10Mbps，使用 20M 带宽，效率 50%
- Hey, this is physical-layer stuff!
  **千兆以太网**
- 采用标准的以太帧格式
- 允许点对点链路和共享广播信道
- 物理编码：8b10b 编码
- 在共享模式，继续使用 CSMA/CD MAC 技术，节点间需要较短距离以提高利用率
- 交换模式：全双工千兆可用于点对点链路
- 站点使用专用信道，基本不会冲突，效率高
- 除非发往同一个目标站点
- 10 Gbps now !
### 以太网使用 CSMA/CD
- 没有时隙
- NIC 如果侦听到其它 NIC 在发送就不发送：载波侦听 carrier sense
- 发送时，适配器当侦听到其它适配器在发送就放弃对当前帧的发送，冲突检测 collision detection
- 冲突后尝试重传，重传前适配器等待一个随机时间，随机访问 random access
1.  **Hubs**
    - Hubs 本质上是物理层的中继器:
      - 从一个端口收，转发到所有其他端口
      - 速率一致
      - 没有帧的缓存
      - 在 hub 端口上没有 CSMA/CD 机制:适配器检测冲突
      - 提供网络管理功能
    - 网段(LAN segments) ：可以允许一个站点发送的网络范围
      - 在一个碰撞域，同时只允许一个站点在发送
      - 如果有 2 个节点同时发送，则会碰撞
      - 通常拥有相同的前缀，比 IP 子网更详细的前缀
    - 所有以 hub 连到一起的站点处在一个网段，处在一个碰撞域
      - 骨干 hub 将所有网段连到了一起
    - 通过 hub 可扩展节点之间的最大距离
    - 通过 HUB,不能将 10BaseT 和 100BaseT 的网络连接到一起
2.  **Switch**
    - 链路层设备：扮演主动角色（端口执行以太网协议）
      - 对帧进行存储和转发
      - 对于到来的帧，检查帧头，根据目标 MAC 地址进行选择性转发
      - 当帧需要向某个（些）网段进行转发，需要使用 CSMA/CD 进行接入控制
      - 通常一个交换机端口一个独立网段
    - 透明：主机对交换机的存在可以不关心
      - 通过交换机相联的各节点好像这些站点是直接相联的一样
      - 有 MAC 地址；无 IP 地址
    - 即插即用，自学习：
      - 交换机无需配置
        **多路同时传输**
    - 主机有一个专用和直接到交换机的连接
    - 交换机缓存到来的帧
    - 对每个帧进入的链路使用以太网协议，没有碰撞；全双工
      - 每条链路都是一个独立的碰撞域
      - MAC 协议在其中的作用弱化了
    - 交换：A-to-A’ 和 B-to-B’ 可以同时传输，没有碰撞
      **交换机转发表**
      **自学习**
    - 交换机通过学习得到哪些主机（mac 地址）可以通过哪些端口到达
    - 当接收到帧，交换机学习到发送站点所在的端口（网段）
    - 记录发送方 MAC 地址/进入端口映射关系，在交换表中
      **过滤／转发**
    - 当交换机收到一个帧:
      1.  记录进入链路，发送主机的 MAC 地址
      2.  使用目标 MAC 地址对交换表进行索引
      3.  过滤转发或泛洪
## IEEE 802.11 Wireless LAN
### 体系结构
- 无线主机与基站通信
  - 基站 base station = 接入点 access point (AP)
- 基础设施模式下的基本服务集 Basic Service Set (BSS) (aka“cell”) 包括以下构件:
  - 无线主机
  - 接入点(AP): 基站
  - 自组织模式下：只有无线主机
### 信道与关联
- 802.11b: 2.4GHz-2.485GHz 频谱被分为 11 个相互不
  同的但是部分重叠的频段
  - AP 管理员为 AP 选择一个频率
  - 可能的干扰: 邻居 AP 可能选择同样一个信道!
- 主机: 必须在通信之前和 AP 建立 associate
  - 扫描所有的信道，侦听包含 AP SSID 和 MAC 地址的信标帧
    - 主动扫描：主机发送探测，接受 AP 的响应
    - 被动扫描
  - 选择希望关联的 AP
  - 可能需要执行鉴别（认证）[Chapter 8]
    - 基于 MAC、用户名口令
    - 通过 AP 的中继，使用 RADIUS 鉴别服务器进行身份鉴别
  - 将会执行 DHCP 获得 IP 地址和 AP 所在的子网前缀
## 交换机与路由器
- 都是存储转发设备，但层次不同
  - 交换机：链路层设备（检查链路层头部）
  - 路由器：网络层设备（检查网络层的头部）
- 都有转发表：
  - 交换机：维护交换表，按照 MAC 地址转发
    - 执行过滤、自学习和生成树算法
    - 即插即用；二层设备，速率高
    - 执行生成树算法，限制广播帧的转发
    - ARP 表项随着站点数量增多而增
  - 路由器：维护路由表，执行路由算法
    - 路由算法能够避免环路，无需执行生成树算法，可以以各种拓扑构建网络
    - 对广播分组做限制
    - 不是即插即用的，配置网络地址（子网前缀）
    - 三层设备，速率低
## VLANs
- 基于端口的 VLAN: 交换机端口成组( 通过交换机管理软件)，以至于单个的交换机可以分成若干虚拟 LANs
  **端口的 VLAN**
- **流量隔离:** 从/到 1-8 端口的流量只会涉及到 1-8 也可以基于 MAC 地址进行 VLAN 定义
- **动态成员:** 成员可以在 VLANs 之间动态分配 router
- **在 VLANs 间转发:** 通过路由器进行转发 (就像他们通过各自的交换机相联一样)
  - 实际操作中，设备生产商可以提供：交换机和路由器的单一设备
    **互联多个交换机**
- 如果有多个交换机，希望它们相连并且**共享 VLANs 信息**
- 方法 1：各交换机每个 VLAN 一个端口和另外交换机相应 VLAN 端口相连->扩展性问题
- **trunk port 干线端口:** 多个交换机共享定义的 VLAN，在它们之间传输帧
  - 帧在不同交换机上的一个 VLAN 上转发，不能够再使用 vanilla 802.1 帧 (必须要携带 VLAN ID 信息)
  - 802.1q 协议增加/移除附加的头部字段，用于在 trunk 端口上进行帧的转发
